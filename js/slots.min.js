function updateProgress(a){progressCount+=a||1,progressCount>=progressTotalCount?($("#progress").css("width","100%"),$("#loading").slideUp(600)):$("#progress").css("width",parseInt(100*progressCount/progressTotalCount)+"%")}function preloader(a,b,c){function f(a,b){updateProgress(1),a&&alert("Failed to load "+b+": "+a),e++,d==e&&c()}var d=a.length,e=0;progressTotalCount+=a.length,a.forEach(function(a){b(a,f)})}function preloadImages(a,b){function c(a,b){a.img=new Image,a.img.src="img/"+a.id+".png",a.img.addEventListener("load",function(){b()},!1),a.img.addEventListener("error",function(c){b(c,a.id)},!1)}preloader(a,c,b)}function _initWebAudio(a,b,c,d){function f(a,c){var d=new XMLHttpRequest;d.open("GET","audio/"+a.id+"."+b,!0),d.responseType="arraybuffer",d.onload=function(){e.decodeAudioData(d.response,function(b){a.play=function(){var a=e.createBufferSource();a.buffer=b,a.connect(e.destination),a.noteOn(0)},a.gainNode=e.createGainNode(),a.gainNode.connect(e.destination),a.gainNode.gain.value=.5,c()},function(b){a.play=function(){},_check(b,a.id)})},d.onerror=function(b){console.log(b),a.play=function(){},c(b,a.id)},d.send()}var e=new a;preloader(c,f,d)}function _initHTML5Audio(a,b,c){function d(b,c){b.audio=new Audio("audio/"+b.id+"."+a),b.audio.preload="auto",b.audio.addEventListener("loadeddata",function(){b.play=function(){b.audio.play()},b.audio.volume=.6,c()},!1),b.audio.addEventListener("error",function(a){b.play=function(){},c(a,b.id)},!1)}preloader(b,d,c)}function initAudio(a,b){var c="mp3",d=document.createElement("audio");d&&!d.canPlayType("audio/mpeg;")&&d.canPlayType("audio/ogg;")&&(c="ogg");var e=window.webkitAudioContext||window.mozAudioContext||window.MSAudioContext||window.AudioContext;return e?($("#audio_debug").text("WebAudio Supported"),_initWebAudio(e,c,a,b)):d?($("#audio_debug").text("HTML5 Audio Supported"),_initHTML5Audio(c,a,b)):($("#audio_debug").text("Audio NOT Supported"),a.forEach(function(a){a.play=function(){}}),b(),void 0)}function copyArray(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return b}function shuffleArray(a){var b;for(b=a.length-1;b>0;b--){var c=parseInt(Math.random()*b),d=a[b];a[b]=a[c],a[c]=d}}function SlotMachine(){function f(){function c(a,b){var c=a.getContext("2d");c.fillStyle="#ddd";for(var d=0;ITEM_COUNT>d;d++){var e=b[d];c.save(),c.shadowColor="rgba(0,0,0,0.5)",c.shadowOffsetX=5,c.shadowOffsetY=5,c.shadowBlur=5,c.drawImage(e.img,3,d*SLOT_HEIGHT+IMAGE_TOP_MARGIN),c.drawImage(e.img,3,(d+ITEM_COUNT)*SLOT_HEIGHT+IMAGE_TOP_MARGIN),c.restore(),c.fillRect(0,d*SLOT_HEIGHT,70,SLOT_SEPARATOR_HEIGHT),c.fillRect(0,(d+ITEM_COUNT)*SLOT_HEIGHT,70,SLOT_SEPARATOR_HEIGHT)}}e&&d&&(a.items1=copyArray(b),shuffleArray(a.items1),c(a.c1[0],a.items1),a.items2=copyArray(b),shuffleArray(a.items2),c(a.c2[0],a.items2),a.items3=copyArray(b),shuffleArray(a.items3),c(a.c3[0],a.items3),a.resetOffset=(ITEM_COUNT+3)*SLOT_HEIGHT,a.loop(),$("#play").click(function(){a.audios[0].play(),a.restart()}))}var a=new Game,b=[{id:"water-64"},{id:"food-64"},{id:"fire-64"},{id:"light-64"},{id:"multitool-64"},{id:"medical-64"}],c=[{id:"roll"},{id:"slot"},{id:"win"},{id:"nowin"}];$("canvas").attr("height",2*IMAGE_HEIGHT*ITEM_COUNT),$("canvas").css("height",2*IMAGE_HEIGHT*ITEM_COUNT),a.items=b,a.audios=c;var d=!1,e=!1;initAudio(c,function(){e=!0,f()}),preloadImages(b,function(){d=!0,f()})}function Game(){this.c1=$("#reel1"),this.c2=$("#reel2"),this.c3=$("#reel3"),this.offset1=-parseInt(Math.random()*ITEM_COUNT)*SLOT_HEIGHT,this.offset2=-parseInt(Math.random()*ITEM_COUNT)*SLOT_HEIGHT,this.offset3=-parseInt(Math.random()*ITEM_COUNT)*SLOT_HEIGHT,this.speed1=this.speed2=this.speed3=0,this.lastUpdate=new Date,this.vendor=/webkit/i.test(navigator.appVersion)?"-webkit":/firefox/i.test(navigator.userAgent)?"-moz":/msie/i.test(navigator.userAgent)?"ms":"opera"in window?"-o":"",this.cssTransform=this.vendor+"-transform",this.has3d="WebKitCSSMatrix"in window&&"m11"in new WebKitCSSMatrix,this.trnOpen="translate"+(this.has3d?"3d(":"("),this.trnClose=this.has3d?",0)":")",this.scaleOpen="scale"+(this.has3d?"3d(":"("),this.scaleClose=this.has3d?",0)":")",this.draw(!0)}var progressCount=0,progressTotalCount=0,IMAGE_HEIGHT=64,IMAGE_TOP_MARGIN=5,IMAGE_BOTTOM_MARGIN=5,SLOT_SEPARATOR_HEIGHT=2,SLOT_HEIGHT=IMAGE_HEIGHT+IMAGE_TOP_MARGIN+IMAGE_BOTTOM_MARGIN+SLOT_SEPARATOR_HEIGHT,RUNTIME=3e3,SPINTIME=1e3,ITEM_COUNT=6,SLOT_SPEED=15,DRAW_OFFSET=45,MESSAGES=["Never give up!","Nice!","Excellent!","JACKPOT!"];Game.prototype.restart=function(){this.lastUpdate=new Date,this.speed1=this.speed2=this.speed3=SLOT_SPEED,this.result1=parseInt(Math.random()*this.items1.length),this.result2=parseInt(Math.random()*this.items2.length),this.result3=parseInt(Math.random()*this.items3.length),this.stopped1=!1,this.stopped2=!1,this.stopped3=!1,this.offset1=-parseInt(Math.random(ITEM_COUNT))*SLOT_HEIGHT,this.offset2=-parseInt(Math.random(ITEM_COUNT))*SLOT_HEIGHT,this.offset3=-parseInt(Math.random(ITEM_COUNT))*SLOT_HEIGHT,$("#results").hide(),this.state=1},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),Game.prototype.loop=function(){var a=this;a.running=!0,function b(){a.update(),a.draw(),a.running&&requestAnimFrame(b)}()},Game.prototype.update=function(){function c(c,d){if(a-b.lastUpdate>SPINTIME){var e=parseInt(Math.abs(c/SLOT_HEIGHT))%ITEM_COUNT;if(e==d)if(0==d){if(Math.abs(c+ITEM_COUNT*SLOT_HEIGHT)<1.5*SLOT_SPEED)return!0}else if(Math.abs(c+d*SLOT_HEIGHT)<1.5*SLOT_SPEED)return!0}return!1}var a=new Date,b=this;switch(this.state){case 1:a-this.lastUpdate>RUNTIME&&(this.state=2,this.lastUpdate=a);break;case 2:this.stopped1=c(this.offset1,this.result1),this.stopped1&&(this.speed1=0,this.state++,this.lastUpdate=a,this.audios[1].play());break;case 3:this.stopped2=c(this.offset2,this.result2),this.stopped2&&(this.speed2=0,this.state++,this.lastUpdate=a,this.audios[1].play());break;case 4:this.stopped3=c(this.offset3,this.result3),this.stopped3&&(this.speed3=0,this.state++,this.audios[1].play());break;case 5:a-this.lastUpdate>3e3&&(this.state=6);break;case 6:var d=0;$("#results").show(),"medical-64"==b.items1[b.result1].id&&d++,"medical-64"==b.items2[b.result2].id&&d++,"medical-64"==b.items3[b.result3].id&&d++,$("#multiplier").text(d),$("#status").text(MESSAGES[d]),d?this.audios[2].play():this.audios[3].play(),this.state=7;break;case 7:}this.lastupdate=a},Game.prototype.draw=function(a){if(!(this.state>=6))for(var b=1;3>=b;b++){var c="result"+b,d="stopped"+b,e="speed"+b,f="offset"+b,g="c"+b;if(this[d]||this[e]||a){if(this[d]){this[e]=0;var h=this[c];this[f]=-(h*SLOT_HEIGHT),this[f]+DRAW_OFFSET>0&&(this[f]=-this.resetOffset+3*SLOT_HEIGHT)}else this[f]+=this[e],this[f]+DRAW_OFFSET>0&&(this[f]=-this.resetOffset+3*SLOT_HEIGHT-DRAW_OFFSET);this[g].css(this.cssTransform,this.trnOpen+"0px, "+(this[f]+DRAW_OFFSET)+"px"+this.trnClose)}}};